<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNG 转 JPEG 转换器--杰哥村落</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .drop-zone--over { border-color: #3b82f6; background-color: #eff6ff; }
        #imageCanvas { display: none; }
    </style>
</head>
<body class="min-h-screen py-12 px-4">

    <div class="max-w-4xl mx-auto">
        <!-- 头部 -->
        <div class="text-center mb-10">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">PNG 转 JPEG</h1>
            <p class="text-gray-600">高效、安全、本地化的图片格式转换工具</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- 左侧：操作面板 -->
            <div class="md:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h2 class="text-sm font-semibold text-gray-700 mb-4 uppercase tracking-wider">转换设置</h2>
                    
                    <!-- 质量滑块 -->
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <label class="text-sm text-gray-600">JPEG 质量</label>
                            <span id="qualityValue" class="text-sm font-medium text-blue-600">90%</span>
                        </div>
                        <input type="range" id="qualityRange" min="1" max="100" value="90" 
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        <p class="text-[11px] text-gray-400 leading-relaxed">
                            较高的质量会产生较大的文件体积。100% 为无损效果。
                        </p>
                    </div>

                    <div class="mt-8">
                        <button id="downloadBtn" disabled class="w-full py-3 bg-gray-200 text-gray-500 rounded-xl font-semibold transition-all flex items-center justify-center gap-2 cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            下载 JPEG
                        </button>
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h3 class="text-xs font-bold text-blue-800 mb-1">隐私说明</h3>
                    <p class="text-xs text-blue-600">转换过程完全在您的浏览器中完成，图片不会上传到任何服务器。</p>
                </div>
            </div>

            <!-- 右侧：上传与预览 -->
            <div class="md:col-span-2 space-y-6">
                <!-- 上传区域 -->
                <div id="dropZone" class="bg-white border-2 border-dashed border-gray-300 rounded-2xl p-8 transition-all flex flex-col items-center justify-center min-h-[250px] cursor-pointer hover:border-blue-400 group">
                    <input type="file" id="fileInput" accept="image/png" class="hidden">
                    
                    <div id="uploadPlaceholder" class="text-center">
                        <div class="mb-4 bg-gray-100 p-4 rounded-full inline-block group-hover:bg-blue-50 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-blue-500"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"></path><line x1="16" y1="5" x2="22" y2="5"></line><line x1="19" y1="2" x2="19" y2="8"></line><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>
                        </div>
                        <p class="text-gray-700 font-medium">点击或拖拽 PNG 图片至此处</p>
                        <p class="text-sm text-gray-400 mt-1">支持最大 20MB 的图片文件</p>
                    </div>

                    <!-- 预览容器 -->
                    <div id="previewContainer" class="hidden w-full space-y-4">
                        <div class="relative rounded-lg overflow-hidden bg-gray-100 border border-gray-200">
                            <img id="imagePreview" src="" alt="预览" class="max-h-[400px] mx-auto object-contain">
                        </div>
                        <div class="flex flex-wrap gap-4 text-sm">
                            <div class="bg-gray-100 px-3 py-1 rounded-md text-gray-600">
                                原文件: <span id="originalSize" class="font-medium text-gray-900">-</span>
                            </div>
                            <div class="bg-green-100 px-3 py-1 rounded-md text-green-700">
                                转换后: <span id="convertedSize" class="font-medium text-green-900">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="msgBox" class="hidden p-4 rounded-xl text-sm font-medium"></div>
            </div>
        </div>
    </div>

    <!-- 隐藏的画布用于转换 -->
    <canvas id="imageCanvas"></canvas>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        const qualityRange = document.getElementById('qualityRange');
        const qualityValue = document.getElementById('qualityValue');
        const downloadBtn = document.getElementById('downloadBtn');
        const originalSizeText = document.getElementById('originalSize');
        const convertedSizeText = document.getElementById('convertedSize');
        const msgBox = document.getElementById('msgBox');

        let currentImg = null;
        let originalFileName = 'image';

        // 格式化文件大小
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 处理文件选择
        function handleFile(file) {
            if (!file || !file.type.match('image/png')) {
                showMsg('请上传有效的 PNG 图片文件。', 'error');
                return;
            }

            originalFileName = file.name.replace(/\.[^/.]+$/, "");
            originalSizeText.textContent = formatBytes(file.size);

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    currentImg = img;
                    processImage();
                    showPreview();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // 执行转换逻辑
        function processImage() {
            if (!currentImg) return;

            const quality = parseInt(qualityRange.value) / 100;
            
            // 设置画布尺寸
            canvas.width = currentImg.width;
            canvas.height = currentImg.height;

            // 关键：绘制白色背景（因为 JPEG 不支持透明）
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 绘制图片
            ctx.drawImage(currentImg, 0, 0);

            // 导出为 JPEG
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            imagePreview.src = dataUrl;

            // 计算转换后的大小 (Base64 大约比原始二进制大 33%)
            const head = 'data:image/jpeg;base64,';
            const convertedSize = Math.round((dataUrl.length - head.length) * 3 / 4);
            convertedSizeText.textContent = formatBytes(convertedSize);

            // 启用下载按钮
            downloadBtn.disabled = false;
            downloadBtn.classList.remove('bg-gray-200', 'text-gray-500', 'cursor-not-allowed');
            downloadBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'shadow-blue-200', 'shadow-lg');
        }

        function showPreview() {
            uploadPlaceholder.classList.add('hidden');
            previewContainer.classList.remove('hidden');
            dropZone.classList.remove('py-8');
            dropZone.classList.add('p-4');
        }

        function showMsg(text, type) {
            msgBox.textContent = text;
            msgBox.className = `p-4 rounded-xl text-sm font-medium ${type === 'error' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`;
            msgBox.classList.remove('hidden');
            setTimeout(() => msgBox.classList.add('hidden'), 4000);
        }

        // 下载功能
        downloadBtn.onclick = () => {
            const link = document.createElement('a');
            link.download = `${originalFileName}_converted.jpg`;
            link.href = imagePreview.src;
            link.click();
        };

        // 交互事件
        qualityRange.oninput = () => {
            qualityValue.textContent = `${qualityRange.value}%`;
            processImage();
        };

        dropZone.onclick = () => fileInput.click();

        fileInput.onchange = (e) => handleFile(e.target.files[0]);

        dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.classList.add('drop-zone--over');
        };

        ['dragleave', 'dragend'].forEach(type => {
            dropZone.addEventListener(type, () => {
                dropZone.classList.remove('drop-zone--over');
            });
        });

        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('drop-zone--over');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        };
    </script>
</body>
</html>
